<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>단어리듬게임</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/minty/bootstrap.min.css">

  <style>
    :root{
      --glow: 0 10px 30px rgba(16,24,40,.12);
      --stroke: rgba(15,23,42,.10);
      --grad1: rgba(99,102,241,.14);
      --grad2: rgba(34,211,238,.14);
      --ink: #0f172a;
    }
    body{
      background:
        radial-gradient(900px 480px at 15% 0%, var(--grad1), transparent 55%),
        radial-gradient(900px 480px at 85% 5%, var(--grad2), transparent 55%),
        #f7fafc;
      min-height: 100vh;
      color: var(--ink);
    }
    .navbar{
      background: rgba(255,255,255,.78) !important;
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--stroke);
      box-shadow: var(--glow);
    }
    .brand-dot{
      width:10px;height:10px;border-radius:999px;
      background: linear-gradient(135deg,#6366f1,#22d3ee);
      display:inline-block; margin-right:.6rem;
      box-shadow: 0 0 0 6px rgba(99,102,241,.08);
    }

    .screen{ display:none; }
    .screen.active{ display:block; }

    .game-card{
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.9);
      box-shadow: var(--glow);
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      will-change: transform;
      animation: popIn .18s ease-out both;
    }
    .game-card:hover{
      transform: translateY(-2px);
      border-color: rgba(99,102,241,.22);
      box-shadow: 0 16px 40px rgba(16,24,40,.14);
    }
    @keyframes popIn{
      from{ transform: translateY(6px); opacity: 0; }
      to{ transform: translateY(0); opacity: 1; }
    }

    .btn-neo{
      border: 1px solid rgba(99,102,241,.22);
      background: linear-gradient(135deg, rgba(99,102,241,.18), rgba(34,211,238,.16));
      color: var(--ink) !important;
      font-weight: 600;
    }
    .btn-neo:hover{
      border-color: rgba(99,102,241,.35);
      box-shadow: 0 10px 26px rgba(99,102,241,.16);
      color: var(--ink) !important;
    }

    .badge-soft{
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(15,23,42,.04);
      color: var(--ink);
    }

    .stars{ white-space:nowrap; }
    .stars .star{ font-size: 1rem; line-height: 1; color: #f59e0b; }
    .stars .off{ opacity:.28; }

    .muted{ color: rgba(15,23,42,.66) !important; }
    .hr-soft{
      border: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(15,23,42,.16), transparent);
      opacity: 1;
    }

    .player-wrap{
      position: relative;
    }
    video{
      width:100%;
      border-radius: 16px;
      border: 1px solid var(--stroke);
      background:#000;
      box-shadow: 0 16px 44px rgba(16,24,40,.12);
      max-height: 72vh;
    }

    .watermark{
      position:absolute;
      inset: 10px 10px auto auto;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.22);
      background: rgba(0,0,0,.35);
      color: rgba(255,255,255,.86);
      font-size: 12px;
      user-select: none;
      pointer-events: none;
      backdrop-filter: blur(6px);
    }

    .table thead th{
      background: rgba(15,23,42,.04);
      border-bottom: 1px solid rgba(15,23,42,.10) !important;
    }
    .table td, .table th{ vertical-align: middle; }
    .table-hover tbody tr:hover{
      background: rgba(99,102,241,.06);
      cursor: pointer;
    }

    .form-control, .form-select{
      border-color: rgba(15,23,42,.14) !important;
      background-color: rgba(255,255,255,.95) !important;
    }
    .form-control:focus, .form-select:focus{
      box-shadow: 0 0 0 .2rem rgba(99,102,241,.14) !important;
      border-color: rgba(99,102,241,.40) !important;
    }

    .toastish{
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 1080;
      min-width: 240px;
      max-width: 420px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.92);
      box-shadow: 0 18px 50px rgba(16,24,40,.14);
      display:none;
    }
    .toastish.show{ display:block; animation: toastIn .18s ease-out both; }
    @keyframes toastIn{
      from{ transform: translateY(10px); opacity: 0; }
      to{ transform: translateY(0); opacity: 1; }
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-expand-lg sticky-top">
    <div class="container">
      <a class="navbar-brand fw-bold text-dark" href="#list">
        <span class="brand-dot"></span>Word Rhythm Videos
      </a>
      <div class="ms-auto d-flex gap-2">
        <button id="btnGoList" class="btn btn-sm btn-outline-primary">목록</button>
        <button id="btnGoAdmin" class="btn btn-sm btn-neo">관리자</button>
      </div>
    </div>
  </nav>

  <main class="container py-4">
    <!-- LIST -->
    <section id="screen-list" class="screen active">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
        <span class="badge badge-soft rounded-pill px-3 py-2">
          총 <span id="listCount">0</span>개
        </span>
      </div>
      <div id="grid" class="row g-3"></div>
    </section>

    <!-- PLAYER -->
    <section id="screen-player" class="screen">
      <div class="card game-card">
        <div class="card-body">
          <div class="d-flex align-items-start justify-content-between flex-wrap gap-2 mb-2">
            <div class="me-auto">
              <h5 id="playerName" class="mb-1 fw-bold text-dark">-</h5>
              <div id="playerStars" class="stars mb-1"></div>
            </div>
            <div class="d-flex gap-2 flex-wrap">
              <button id="btnBack" class="btn btn-outline-primary">← 뒤로</button>
              <button id="btnPlayPause" class="btn btn-neo">⏯ 재생/일시정지</button>
            </div>
          </div>

          <hr class="hr-soft my-3">

          <div class="player-wrap">
            <div class="watermark">Protected</div>
            <video id="video"
                   controls
                   playsinline
                   preload="metadata"
                   controlsList="nodownload noplaybackrate noremoteplayback"
                   disablePictureInPicture
                   oncontextmenu="return false;"></video>
          </div>

        </div>
      </div>
    </section>

    <!-- ADMIN -->
    <section id="screen-admin" class="screen">
      <div class="row g-3">
        <div class="col-12 col-lg-5">
          <div class="card game-card">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between">
                <h5 class="mb-0 fw-bold text-dark">관리자</h5>
                <div class="d-flex gap-2">
                  <button id="btnSignOut" class="btn btn-sm btn-outline-secondary d-none" type="button">로그아웃</button>
                  <button id="btnResetForm" class="btn btn-sm btn-outline-secondary d-none" type="button">초기화</button>
                </div>
              </div>

              <hr class="hr-soft my-3">

              <!-- AUTH -->
              <div id="authBox" class="d-none">
                <div class="mb-3">
                  <label class="form-label">이메일</label>
                  <input id="authEmail" class="form-control" type="email" autocomplete="email" />
                </div>
                <div class="mb-3">
                  <label class="form-label">비밀번호</label>
                  <input id="authPass" class="form-control" type="password" autocomplete="current-password" />
                </div>
                <div class="d-flex gap-2">
                  <button id="btnLogin" class="btn btn-neo flex-grow-1" type="button">로그인</button>
                </div>
              </div>

              <!-- FORM -->
              <form id="adminForm" class="d-none">
                <input type="hidden" id="fId" />
                <input type="hidden" id="fFilePath" />

                <div class="mb-3">
                  <label class="form-label">이름</label>
                  <input id="fName" class="form-control" maxlength="60" required />
                </div>

                <div class="mb-3">
                  <label class="form-label">난이도 (1~5)</label>
                  <select id="fDifficulty" class="form-select" required>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3" selected>3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                  </select>
                </div>

                <div class="mb-3">
                  <label class="form-label">영상 업로드</label>
                  <input id="fFile" type="file" class="form-control" accept="video/mp4,video/webm,video/ogg,video/quicktime,video/x-m4v" />
                  <div id="fileHint" class="muted small mt-1"></div>
                </div>
                <div class="mb-3">
                  <label class="form-label">메모</label>
                  <input id="fMemo" class="form-control" maxlength="120" placeholder="목록에 표시될 문구(예: 오늘의 말씀/레벨 설명 등)" />
                </div>

                <div class="d-flex gap-2">
                  <button id="btnSave" class="btn btn-neo flex-grow-1" type="submit">저장</button>
                  <button id="btnDelete" class="btn btn-outline-danger" type="button" disabled>삭제</button>
                </div>
              </form>

              <div id="adminLocked" class="muted small"></div>
            </div>
          </div>
        </div>

        <div class="col-12 col-lg-7">
          <div class="card game-card">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                <h5 class="mb-0 fw-bold text-dark">영상 목록</h5>
                <div class="d-flex align-items-center gap-2">
                  <span class="badge badge-soft rounded-pill px-3 py-2">
                    총 <span id="adminCount">0</span>개
                  </span>
                  <button id="btnAdminAdd" class="btn btn-sm btn-neo d-none" type="button">+ 추가</button>
                  <button id="btnRelink" class="btn btn-sm btn-outline-primary" type="button">영상 다시 연결</button>
                </div>
              </div>

              <hr class="hr-soft my-3">

              <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                  <thead>
                    <tr>
                      <th style="width: 64%;">이름</th>
                      <th style="width: 20%;">난이도</th>
                      <th style="width: 16%;">상태</th>
                    </tr>
                  </thead>
                  <tbody id="adminTbody"></tbody>
                </table>
              </div>

            </div>
          </div>
        </div>

      </div>
    </section>
  </main>

  <!-- Delete confirm modal -->
  <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title fw-bold">삭제 확인</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="text-dark">정말 삭제할까요?</div>
          <div id="deleteTarget" class="muted small mt-1"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">취소</button>
          <button type="button" class="btn btn-danger" id="btnConfirmDelete">삭제</button>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toastish"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // =========================
  // Local-only (No DB, No Server)
  // =========================

  const LS_KEY = "awana_local_videos_v1";

  const $ = (s) => document.querySelector(s);
  const screens = { list: $("#screen-list"), player: $("#screen-player"), admin: $("#screen-admin") };

  const grid = $("#grid");
  const listCount = $("#listCount");
  const adminCount = $("#adminCount");

  const playerName = $("#playerName");
  const playerStars = $("#playerStars");
  const videoEl = $("#video");

  const btnBack = $("#btnBack");
  const btnPlayPause = $("#btnPlayPause");

  const btnGoList = $("#btnGoList");
  const btnGoAdmin = $("#btnGoAdmin");

  const adminTbody = $("#adminTbody");
  const adminForm = $("#adminForm");
  const btnResetForm = $("#btnResetForm");
  const btnDelete = $("#btnDelete");
  const btnAdminAdd = $("#btnAdminAdd");
  const btnSave = $("#btnSave");

  const fId = $("#fId");
  const fFilePath = $("#fFilePath"); // fileKey 저장용
  const fName = $("#fName");
  const fMemo = $("#fMemo");
  const fDifficulty = $("#fDifficulty");
  const fFile = $("#fFile");
  const fileHint = $("#fileHint");

  const toastEl = $("#toast");
  const btnRelink = $("#btnRelink");

  // 브라우저 메모리에만 유지되는 파일 맵: fileKey -> File
  const fileMap = new Map();

  // 저장 중 중복 submit 방지
  let saving = false;

  function toast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    clearTimeout(toastEl._t);
    toastEl._t = setTimeout(()=>toastEl.classList.remove("show"), 1600);
  }

  function escapeHTML(s) {
    return String(s ?? "").replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  function starsHTML(n) {
    const max = 5;
    let html = "";
    for (let i = 1; i <= max; i++) html += `<span class="star ${i <= n ? "" : "off"}">★</span>`;
    return html;
  }

  function setScreen(name) {
    Object.values(screens).forEach(s => s.classList.remove("active"));
    screens[name].classList.add("active");
  }

  function uid(){
    return (crypto?.randomUUID?.() || ("id_" + Date.now() + "_" + Math.random().toString(16).slice(2)));
  }

  function makeFileKey(file){
    // 브라우저 재연결용 키
    return `${file.name}::${file.size}`;
  }

  // -------------------------
  // Storage (localStorage)
  // -------------------------
  let VIDEOS = [];

  function loadVideos(){
    try {
      const raw = localStorage.getItem(LS_KEY);
      VIDEOS = raw ? JSON.parse(raw) : [];
    } catch {
      VIDEOS = [];
    }
  }

  function saveVideos(){
    localStorage.setItem(LS_KEY, JSON.stringify(VIDEOS));
  }

  // -------------------------
  // Render
  // -------------------------
  function renderList() {
    listCount.textContent = String(VIDEOS.length);

    grid.innerHTML = VIDEOS.map(v => {
      const memoText = (v.memo || "").trim();  // ✅ 메모 없으면 공백 처리
      return `
        <div class="col-12 col-md-6 col-lg-4">
          <div class="card game-card h-100" role="button" tabindex="0" data-id="${escapeHTML(v.id)}">
            <div class="card-body">
              <div class="d-flex justify-content-between gap-2">
                <div class="me-auto">
                  <!-- ✅ 목록에는 메모만 표시 (메모 없으면 아무것도 안 보이게) -->
                  <div class="fw-bold text-dark">${memoText ? escapeHTML(memoText) : "&nbsp;"}</div>
                </div>
                <div class="stars">${starsHTML(Number(v.difficulty) || 1)}</div>
              </div>
            </div>
          </div>
        </div>
      `;
    }).join("");

    grid.querySelectorAll("[data-id]").forEach(card => {
      const id = card.getAttribute("data-id");
      const open = () => { window.location.hash = `#play=${encodeURIComponent(id)}`; };
      card.addEventListener("click", open);
      card.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") { e.preventDefault(); open(); }
      });
    });
  }

  function renderAdmin() {
    adminCount.textContent = String(VIDEOS.length);

    adminTbody.innerHTML = VIDEOS.map(v => {
      const linked = v.fileKey && fileMap.has(v.fileKey);
      return `
        <tr data-id="${escapeHTML(v.id)}" role="button" tabindex="0" title="클릭해서 편집">
          <td class="fw-semibold text-dark">${escapeHTML(v.name)}</td>
          <td class="stars">${starsHTML(Number(v.difficulty) || 1)}</td>
          <td class="small ${linked ? "text-success" : "muted"}">
            ${linked ? "연결됨" : "미연결"}
          </td>
        </tr>
      `;
    }).join("");

    adminTbody.querySelectorAll("tr[data-id]").forEach(row => {
      const id = row.getAttribute("data-id");
      const openEdit = () => {
        const item = VIDEOS.find(x => x.id === id);
        if (!item) return;
        fillAdminForm(item);
      };
      row.addEventListener("click", openEdit);
      row.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") { e.preventDefault(); openEdit(); }
      });
    });
  }

  // -------------------------
  // Admin form
  // -------------------------
  function resetAdminForm() {
    fId.value = "";
    fFilePath.value = "";
    fName.value = "";
    fMemo.value = "";
    fDifficulty.value = "3";
    fFile.value = "";
    btnDelete.disabled = true;
    fileHint.textContent = "새 항목은 영상 파일 선택 후 저장";
  }

  function fillAdminForm(item) {
    fId.value = item.id;
    fFilePath.value = item.fileKey || "";
    fName.value = item.name || "";
    fMemo.value = item.memo || "";
    fDifficulty.value = String(item.difficulty || 3);
    fFile.value = "";
    btnDelete.disabled = false;

    const linked = item.fileKey && fileMap.has(item.fileKey);
    fileHint.textContent = linked
      ? "현재 브라우저에서 파일 연결됨 (바꾸려면 새 파일 선택)"
      : "파일 미연결: [영상 다시 연결]로 파일들을 다시 선택하세요";
  }

  // 저장(등록)
  adminForm.addEventListener("submit", (e) => {
    e.preventDefault();
    if (saving) return;
    saving = true;
    btnSave.disabled = true;

    try {
      const name = fName.value.trim();
      const memo = fMemo.value.trim();
      const difficulty = Math.min(5, Math.max(1, Number(fDifficulty.value) || 1));

      const id = fId.value.trim();
      const existingFileKey = fFilePath.value.trim();
      const file = fFile.files && fFile.files[0];

      if (!name) { toast("이름을 입력하세요"); return; }

      // 새 항목 생성: 파일 필수 (정책 그대로)
      if (!id && !file) {
        toast("새 항목은 영상 파일을 선택해야 해요");
        return;
      }

      // fileKey 결정
      let fileKey = existingFileKey;
      if (file) {
        fileKey = makeFileKey(file);
        fileMap.set(fileKey, file);
      }

      // ✅ 동일 파일(fileKey) 중복 등록 방지: 새로 추가 시 이미 있으면 업데이트로 처리
      if (!id && fileKey) {
        const dup = VIDEOS.find(v => v.fileKey === fileKey);
        if (dup) {
          dup.name = name;
          dup.memo = memo;
          dup.difficulty = difficulty;
          saveVideos();
          toast("이미 등록된 파일이라 항목을 업데이트했어요");
          resetAdminForm();
          route();
          return;
        }
      }

      if (!id) {
        // ✅ 딱 1번만 추가 (중복 추가 제거 완료)
        VIDEOS.unshift({ id: uid(), name, memo, difficulty, fileKey });
      } else {
        const idx = VIDEOS.findIndex(v => v.id === id);
        if (idx >= 0) {
          VIDEOS[idx] = { ...VIDEOS[idx], name, memo, difficulty, fileKey };
        }
      }

      saveVideos();
      toast("저장됨");
      resetAdminForm();
      route();
    } finally {
      saving = false;
      btnSave.disabled = false;
    }
  });

  // 삭제
  btnDelete.addEventListener("click", () => {
    const id = fId.value.trim();
    if (!id) return;

    const item = VIDEOS.find(v => v.id === id);
    if (!item) return;

    if (!confirm(`삭제할까요?\n\n${item.name}`)) return;

    VIDEOS = VIDEOS.filter(v => v.id !== id);
    saveVideos();
    toast("삭제됨");
    resetAdminForm();
    route();
  });

  // 초기화/추가
  btnResetForm?.addEventListener("click", resetAdminForm);
  btnAdminAdd?.addEventListener("click", () => { resetAdminForm(); fName.focus(); });

  // -------------------------
  // Relink: 파일을 한 번에 다시 선택해서 매칭
  // -------------------------
  function relinkFilesViaPicker(){
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "video/*";
    input.multiple = true;

    input.addEventListener("change", () => {
      const files = Array.from(input.files || []);
      for (const f of files) {
        const k = makeFileKey(f);
        fileMap.set(k, f);
      }

      let linked = 0;
      for (const v of VIDEOS) {
        if (v.fileKey && fileMap.has(v.fileKey)) linked++;
      }

      toast(`파일 ${files.length}개 선택 / 연결된 항목 ${linked}개`);
      renderAdmin();
      renderList();
    });

    input.click();
  }

  btnRelink?.addEventListener("click", relinkFilesViaPicker);

  // -------------------------
  // Player
  // -------------------------
  let currentPlayId = null;
  let currentObjectUrl = null;

  function cleanupObjectUrl(){
    if (currentObjectUrl) {
      URL.revokeObjectURL(currentObjectUrl);
      currentObjectUrl = null;
    }
  }

  function showPlayer(id) {
    const v = VIDEOS.find(x => x.id === id);
    if (!v) { window.location.hash = "#list"; return; }

    currentPlayId = id;
    playerName.textContent = v.name || "-";
    playerStars.innerHTML = starsHTML(Number(v.difficulty) || 1);

    const f = v.fileKey ? fileMap.get(v.fileKey) : null;
    if (!f) {
      toast("이 브라우저에서 파일이 아직 연결되지 않았어요");
      window.location.hash = "#admin";
      setTimeout(()=>toast("관리자에서 [영상 다시 연결]을 눌러 파일들을 선택하세요"), 250);
      return;
    }

    cleanupObjectUrl();
    currentObjectUrl = URL.createObjectURL(f);
    videoEl.src = currentObjectUrl;
    videoEl.load();
    setScreen("player");
  }

  // -------------------------
  // Controls / Nav
  // -------------------------
  btnBack.addEventListener("click", () => { window.location.hash = "#list"; });
  btnPlayPause.addEventListener("click", () => { if (videoEl.paused) videoEl.play(); else videoEl.pause(); });
  btnGoList.addEventListener("click", () => { window.location.hash = "#list"; });
  btnGoAdmin.addEventListener("click", () => { window.location.hash = "#admin"; });

  window.addEventListener("contextmenu", (e) => e.preventDefault(), { capture: true });

  window.addEventListener("keydown", (e) => {
    const tag = (document.activeElement && document.activeElement.tagName) || "";
    const inInput = tag === "INPUT" || tag === "TEXTAREA" || tag === "SELECT";

    if (!inInput && e.code === "Space" && screens.player.classList.contains("active")) {
      e.preventDefault();
      if (videoEl.paused) videoEl.play(); else videoEl.pause();
    }
    if (e.key === "Escape" && screens.player.classList.contains("active")) {
      window.location.hash = "#list";
    }
  });

  // -------------------------
  // Router
  // -------------------------
  function route() {
    const hash = window.location.hash || "#list";
    const mPlay = hash.match(/^#play=(.+)$/);

    loadVideos();
    renderList();

    if (mPlay) {
      showPlayer(decodeURIComponent(mPlay[1]));
      return;
    }

    if (hash === "#admin") {
      setScreen("admin");

      // 로그인 UI 사용 안 함: 폼 보여주기
      $("#authBox")?.classList.add("d-none");
      $("#adminLocked")?.classList.add("d-none");
      adminForm.classList.remove("d-none");

      btnResetForm?.classList.remove("d-none");
      btnAdminAdd?.classList.remove("d-none");

      renderAdmin();
      return;
    }

    try { videoEl.pause(); } catch {}
    cleanupObjectUrl();
    currentPlayId = null;
    setScreen("list");
  }

  window.addEventListener("hashchange", route);

  // init
  resetAdminForm();
  route();
</script>



</body>
</html>
