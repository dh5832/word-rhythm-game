<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>로컬 영상 단어리듬</title>
  <style>
    body{font-family:system-ui, sans-serif; margin:20px;}
    .row{display:flex; gap:16px; flex-wrap:wrap;}
    .card{border:1px solid #ddd; border-radius:12px; padding:12px; min-width:280px;}
    button{padding:10px 12px; border-radius:10px; border:1px solid #ccc; background:#fff; cursor:pointer;}
    button:hover{background:#f5f5f5;}
    ul{padding-left:18px;}
    li{margin:8px 0; cursor:pointer;}
    li:hover{text-decoration:underline;}
    video{width:100%; max-width:720px; border-radius:12px; background:#000;}
    small{color:#666;}
  </style>
</head>
<body>
  <h2>로컬 영상 등록(PC/브라우저별)</h2>
  <div class="row">
    <div class="card">
      <h3>관리자</h3>
      <input id="fileInput" type="file" accept="video/*" multiple />
      <div style="height:10px"></div>
      <button id="saveListBtn">목록 저장(이름만)</button>
      <button id="clearBtn">목록 초기화</button>
      <p><small>※ 다른 PC/브라우저에서는 다시 파일을 선택(등록)해야 재생됩니다.</small></p>
    </div>

    <div class="card" style="flex:1">
      <h3>목록</h3>
      <button id="relinkBtn">영상 다시 연결하기(재선택)</button>
      <ul id="list"></ul>
    </div>
  </div>

  <div class="card" style="margin-top:16px;">
    <h3>재생</h3>
    <div id="now"></div>
    <video id="player" controls playsinline></video>
  </div>

<script>
  const LS_KEY = "awana_video_manifest_v1";

  // 메모리상 파일 맵: fileName -> File
  const fileMap = new Map();

  const fileInput = document.getElementById("fileInput");
  const listEl = document.getElementById("list");
  const player = document.getElementById("player");
  const now = document.getElementById("now");

  function loadManifest(){
    try { return JSON.parse(localStorage.getItem(LS_KEY) || "[]"); }
    catch { return []; }
  }
  function saveManifest(manifest){
    localStorage.setItem(LS_KEY, JSON.stringify(manifest));
  }

  function renderList(){
    const manifest = loadManifest();
    listEl.innerHTML = "";
    if(manifest.length === 0){
      listEl.innerHTML = "<li><small>등록된 목록이 없습니다.</small></li>";
      return;
    }
    for(const item of manifest){
      const li = document.createElement("li");
      li.textContent = item.title || item.fileName;
      li.dataset.fileName = item.fileName;
      li.addEventListener("click", () => playByFileName(item.fileName, li.textContent));
      listEl.appendChild(li);
    }
  }

  function playByFileName(fileName, title){
    const f = fileMap.get(fileName);
    if(!f){
      alert("이 브라우저에서 아직 영상 파일이 연결되지 않았어요.\n[영상 다시 연결하기]로 파일들을 다시 선택해 주세요.");
      return;
    }
    const url = URL.createObjectURL(f);
    player.src = url;
    now.textContent = "재생중: " + (title || fileName);
    player.play().catch(()=>{});
  }

  // 파일 선택하면 메모리에 맵핑
  fileInput.addEventListener("change", () => {
    fileMap.clear();
    const files = Array.from(fileInput.files || []);
    for(const f of files){
      fileMap.set(f.name, f);
    }
    alert(`선택됨: ${files.length}개\n목록으로 저장하려면 [목록 저장]을 누르세요.`);
  });

  // 선택한 파일들의 이름을 manifest로 저장(이름만)
  document.getElementById("saveListBtn").addEventListener("click", () => {
    const files = Array.from(fileInput.files || []);
    if(files.length === 0) return alert("먼저 영상을 선택하세요.");

    // 파일명 기준으로 목록 만들기(원하면 제목 규칙 적용 가능)
    const manifest = files.map(f => ({
      fileName: f.name,
      title: f.name.replace(/\.[^/.]+$/, "") // 확장자 제거
    }));

    saveManifest(manifest);
    renderList();
    alert("목록 저장 완료! (다음에 들어와도 목록은 남지만 재생하려면 파일을 다시 선택해야 해요)");
  });

  document.getElementById("clearBtn").addEventListener("click", () => {
    localStorage.removeItem(LS_KEY);
    renderList();
    alert("목록 초기화 완료");
  });

  // 재연결: 파일 다시 선택해서 fileMap 채우기
  document.getElementById("relinkBtn").addEventListener("click", async () => {
    // file input을 눌러 다시 선택 유도
    fileInput.click();
  });

  renderList();
</script>
</body>
</html>
