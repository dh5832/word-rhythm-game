<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>단어리듬게임</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/minty/bootstrap.min.css">

  <style>
    :root{
      --glow: 0 10px 30px rgba(16,24,40,.12);
      --stroke: rgba(15,23,42,.10);
      --grad1: rgba(99,102,241,.14);
      --grad2: rgba(34,211,238,.14);
      --ink: #0f172a;
    }
    body{
      background:
        radial-gradient(900px 480px at 15% 0%, var(--grad1), transparent 55%),
        radial-gradient(900px 480px at 85% 5%, var(--grad2), transparent 55%),
        #f7fafc;
      min-height: 100vh;
      color: var(--ink);
    }
    .navbar{
      background: rgba(255,255,255,.78) !important;
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--stroke);
      box-shadow: var(--glow);
    }
    .brand-dot{
      width:10px;height:10px;border-radius:999px;
      background: linear-gradient(135deg,#6366f1,#22d3ee);
      display:inline-block; margin-right:.6rem;
      box-shadow: 0 0 0 6px rgba(99,102,241,.08);
    }

    .screen{ display:none; }
    .screen.active{ display:block; }

    .game-card{
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.9);
      box-shadow: var(--glow);
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      will-change: transform;
      animation: popIn .18s ease-out both;
    }
    .game-card:hover{
      transform: translateY(-2px);
      border-color: rgba(99,102,241,.22);
      box-shadow: 0 16px 40px rgba(16,24,40,.14);
    }
    @keyframes popIn{
      from{ transform: translateY(6px); opacity: 0; }
      to{ transform: translateY(0); opacity: 1; }
    }

    .btn-neo{
      border: 1px solid rgba(99,102,241,.22);
      background: linear-gradient(135deg, rgba(99,102,241,.18), rgba(34,211,238,.16));
      color: var(--ink) !important;
      font-weight: 600;
    }
    .btn-neo:hover{
      border-color: rgba(99,102,241,.35);
      box-shadow: 0 10px 26px rgba(99,102,241,.16);
      color: var(--ink) !important;
    }

    .badge-soft{
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(15,23,42,.04);
      color: var(--ink);
    }

    .stars{ white-space:nowrap; }
    .stars .star{ font-size: 1rem; line-height: 1; color: #f59e0b; }
    .stars .off{ opacity:.28; }

    .muted{ color: rgba(15,23,42,.66) !important; }
    .hr-soft{
      border: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(15,23,42,.16), transparent);
      opacity: 1;
    }

    .player-wrap{ position: relative; }
    video{
      width:100%;
      border-radius: 16px;
      border: 1px solid var(--stroke);
      background:#000;
      box-shadow: 0 16px 44px rgba(16,24,40,.12);
      max-height: 72vh;
    }

    .watermark{
      position:absolute;
      inset: 10px 10px auto auto;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.22);
      background: rgba(0,0,0,.35);
      color: rgba(255,255,255,.86);
      font-size: 12px;
      user-select: none;
      pointer-events: none;
      backdrop-filter: blur(6px);
    }

    .toastish{
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 1080;
      min-width: 240px;
      max-width: 420px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.92);
      box-shadow: 0 18px 50px rgba(16,24,40,.14);
      display:none;
    }
    .toastish.show{ display:block; animation: toastIn .18s ease-out both; }
    @keyframes toastIn{
      from{ transform: translateY(10px); opacity: 0; }
      to{ transform: translateY(0); opacity: 1; }
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-expand-lg sticky-top">
    <div class="container">
      <a class="navbar-brand fw-bold text-dark" href="#list">
        <span class="brand-dot"></span>Word Rhythm Videos
      </a>
      <div class="ms-auto d-flex gap-2">
        <button id="btnGoList" class="btn btn-sm btn-outline-primary">목록</button>
        <a class="btn btn-sm btn-neo" href="admin.html">관리자</a>
      </div>
    </div>
  </nav>

  <main class="container py-4">
    <!-- LIST -->
    <section id="screen-list" class="screen active">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
        <span class="badge badge-soft rounded-pill px-3 py-2">
          총 <span id="listCount">0</span>개
        </span>
      </div>
      <div id="grid" class="row g-3"></div>
    </section>

    <!-- PLAYER -->
    <section id="screen-player" class="screen">
      <div class="card game-card">
        <div class="card-body">
          <div class="d-flex align-items-start justify-content-between flex-wrap gap-2 mb-2">
            <div class="me-auto">
              <h5 id="playerName" class="mb-1 fw-bold text-dark">-</h5>
              <div id="playerScore" class="muted small mt-1">점수: 0</div>
              <div id="playerStars" class="stars mb-1"></div>
            </div>
            <div class="d-flex gap-2 flex-wrap">
              <button id="btnBack" class="btn btn-outline-primary">← 뒤로</button>
              <button id="btnPlayPause" class="btn btn-neo">⏯ 재생/일시정지</button>
            </div>
          </div>

          <hr class="hr-soft my-3">

          <div class="player-wrap">
            <div class="watermark">Protected</div>
            <video id="video"
                   controls
                   playsinline
                   preload="metadata"
                   controlsList="nodownload noplaybackrate noremoteplayback"
                   disablePictureInPicture
                   oncontextmenu="return false;"></video>
          </div>

        </div>
      </div>
    </section>
  </main>

  <div id="toast" class="toastish"></div>

  <script src="app.js"></script>
  <script>
    const screens = { list: $("#screen-list"), player: $("#screen-player") };
    const grid = $("#grid");
    const listCount = $("#listCount");

    const playerName = $("#playerName");
    const playerScore = $("#playerScore");
    const playerStars = $("#playerStars");
    const videoEl = $("#video");

    const btnBack = $("#btnBack");
    const btnPlayPause = $("#btnPlayPause");
    const btnGoList = $("#btnGoList");

    let VIDEOS = [];
    let loaded = false;

    function setScreen(name){
      Object.values(screens).forEach(s => s.classList.remove("active"));
      screens[name].classList.add("active");
    }

    async function loadVideosOnce(){
      if (loaded) return;
      loaded = true;
      try{
        VIDEOS = await fetchVideos();
      }catch(e){
        VIDEOS = [];
        toast("videos.json을 불러오지 못했어요");
        console.error(e);
      }
    }

    function renderList(){
      listCount.textContent = String(VIDEOS.length);

      grid.innerHTML = VIDEOS.map(v => {
        const memoText = (v.memo || "").trim();
        return `
          <div class="col-12 col-md-6 col-lg-4">
            <div class="card game-card h-100" role="button" tabindex="0" data-id="${escapeHTML(v.id)}">
              <div class="card-body">
                <div class="d-flex justify-content-between gap-2">
                  <div class="me-auto">
                    <div class="fw-bold text-dark">${escapeHTML(v.name || "")}</div>
                    <div class="muted small mt-1">점수: ${getScore(v)}</div>
                    ${memoText ? `<div class="muted small mt-2">${escapeHTML(memoText)}</div>` : ``}
                  </div>
                  <div class="stars">${starsHTML(v.difficulty)}</div>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join("");

      grid.querySelectorAll("[data-id]").forEach(card => {
        const id = card.getAttribute("data-id");
        const open = () => { location.hash = `#play=${encodeURIComponent(id)}`; };
        card.addEventListener("click", open);
        card.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") { e.preventDefault(); open(); }
        });
      });
    }

    function showPlayer(id){
      const v = VIDEOS.find(x => String(x.id) === String(id));
      if (!v) { location.hash = "#list"; return; }

      playerName.textContent = v.name || "-";
      playerScore.textContent = `점수: ${getScore(v)}`;
      playerStars.innerHTML = starsHTML(v.difficulty);

      if (!v.url) {
        toast("이 항목은 영상 URL이 없어요");
        location.hash = "#list";
        return;
      }

      videoEl.src = v.url;
      videoEl.load();
      setScreen("player");
    }

    btnBack.addEventListener("click", () => { location.hash = "#list"; });
    btnPlayPause.addEventListener("click", () => { if (videoEl.paused) videoEl.play(); else videoEl.pause(); });
    btnGoList.addEventListener("click", () => { location.hash = "#list"; });

    window.addEventListener("contextmenu", (e) => e.preventDefault(), { capture: true });

    window.addEventListener("keydown", (e) => {
      const tag = (document.activeElement && document.activeElement.tagName) || "";
      const inInput = tag === "INPUT" || tag === "TEXTAREA" || tag === "SELECT";

      if (!inInput && e.code === "Space" && screens.player.classList.contains("active")) {
        e.preventDefault();
        if (videoEl.paused) videoEl.play(); else videoEl.pause();
      }
      if (e.key === "Escape" && screens.player.classList.contains("active")) {
        location.hash = "#list";
      }
    });

    async function route(){
      await loadVideosOnce();
      renderList();

      const hash = location.hash || "#list";
      const mPlay = hash.match(/^#play=(.+)$/);

      if (mPlay) {
        showPlayer(decodeURIComponent(mPlay[1]));
        return;
      }

      try { videoEl.pause(); } catch {}
      setScreen("list");
    }

    window.addEventListener("hashchange", route);
    route();
  </script>
</body>
</html>
