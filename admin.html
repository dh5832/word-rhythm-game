<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>관리자 · 단어리듬게임</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/minty/bootstrap.min.css">

  <style>
    :root{
      --glow: 0 10px 30px rgba(16,24,40,.12);
      --stroke: rgba(15,23,42,.10);
      --grad1: rgba(99,102,241,.14);
      --grad2: rgba(34,211,238,.14);
      --ink: #0f172a;
    }
    body{
      background:
        radial-gradient(900px 480px at 15% 0%, var(--grad1), transparent 55%),
        radial-gradient(900px 480px at 85% 5%, var(--grad2), transparent 55%),
        #f7fafc;
      min-height: 100vh;
      color: var(--ink);
    }
    .navbar{
      background: rgba(255,255,255,.78) !important;
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--stroke);
      box-shadow: var(--glow);
    }
    .brand-dot{
      width:10px;height:10px;border-radius:999px;
      background: linear-gradient(135deg,#6366f1,#22d3ee);
      display:inline-block; margin-right:.6rem;
      box-shadow: 0 0 0 6px rgba(99,102,241,.08);
    }
    .game-card{
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.9);
      box-shadow: var(--glow);
    }
    .badge-soft{
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(15,23,42,.04);
      color: var(--ink);
    }
    .stars{ white-space:nowrap; }
    .stars .star{ font-size: 1rem; line-height: 1; color: #f59e0b; }
    .stars .off{ opacity:.28; }
    .muted{ color: rgba(15,23,42,.66) !important; }

    .table thead th{
      background: rgba(15,23,42,.04);
      border-bottom: 1px solid rgba(15,23,42,.10) !important;
    }
    .table td, .table th{ vertical-align: middle; }

    .toastish{
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 1080;
      min-width: 240px;
      max-width: 420px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.92);
      box-shadow: 0 18px 50px rgba(16,24,40,.14);
      display:none;
    }
    .toastish.show{ display:block; animation: toastIn .18s ease-out both; }
    @keyframes toastIn{
      from{ transform: translateY(10px); opacity: 0; }
      to{ transform: translateY(0); opacity: 1; }
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-expand-lg sticky-top">
    <div class="container">
      <a class="navbar-brand fw-bold text-dark" href="index.html">
        <span class="brand-dot"></span>Admin
      </a>
      <div class="ms-auto d-flex gap-2">
        <a class="btn btn-sm btn-outline-primary" href="index.html">사용자 화면</a>
        <button id="btnSaveAll" class="btn btn-sm btn-primary" type="button">변경사항 저장</button>
        <button id="btnResetSession" class="btn btn-sm btn-outline-secondary" type="button">세션 초기화</button>
      </div>
    </div>
  </nav>

  <main class="container py-4">
    <div class="card game-card">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
          <h5 class="mb-0 fw-bold text-dark">영상 목록</h5>
          <span class="badge badge-soft rounded-pill px-3 py-2">
            총 <span id="adminCount">0</span>개
          </span>
        </div>

        <hr class="hr-soft my-3">
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead>
              <tr>
                <th style="width: 54%;">이름</th>
                <th style="width: 16%;">난이도</th>
                <th style="width: 18%;">성공 점수</th>
                <th style="width: 12%;">상태</th>
              </tr>
            </thead>
            <tbody id="adminTbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <div id="toast" class="toastish"></div>

  <script src="app.js"></script>
  <script>
    const adminCount = $("#adminCount");
    const adminTbody = $("#adminTbody");
    const btnSaveAll = $("#btnSaveAll");
    const btnResetSession = $("#btnResetSession");

    let VIDEOS = [];

    function render(){
      adminCount.textContent = String(VIDEOS.length);
      const scoreMap = loadScoreOverrides();

      adminTbody.innerHTML = VIDEOS.map(v => {
        const ok = !!(v.url && typeof v.url === "string");
        const id = String(v.id ?? "");
        const currentScore = (scoreMap[id] !== undefined ? scoreMap[id] : (Number(v.score ?? 0) || 0));

        return `
          <tr data-id="${escapeHTML(id)}">
            <td class="fw-semibold text-dark">
              <div>${escapeHTML(v.name || "")}</div>
              ${(v.memo || "").trim() ? `<div class="muted small mt-1">${escapeHTML(v.memo)}</div>` : ``}
            </td>
            <td class="stars">${starsHTML(v.difficulty)}</td>
            <td>
              <input class="form-control form-control-sm score-input"
                     type="number" min="0" step="1"
                     value="${escapeHTML(currentScore)}" />
            </td>
            <td class="small ${ok ? "text-success" : "text-danger"}">
              ${ok ? "양호" : "누락"}
            </td>
          </tr>
        `;
      }).join("");
    }

    async function init(){
      try{
        VIDEOS = await fetchVideos();
        render();
      }catch(e){
        toast("비디오를 불러오지 못했어요");
        console.error(e);
      }
    }

    btnSaveAll.addEventListener("click", () => {
      const map = loadScoreOverrides();

      adminTbody.querySelectorAll("tr[data-id]").forEach(tr => {
        const id = tr.getAttribute("data-id");
        const input = tr.querySelector(".score-input");
        if (!id || !input) return;

        const val = Math.max(0, Number(input.value || 0) || 0);
        input.value = String(val);
        map[id] = val;
      });

      saveScoreOverrides(map);
      toast("변경사항 저장됨");
    });

    btnResetSession.addEventListener("click", () => {
      sessionStorage.removeItem("wr_score_overrides_v1");
      toast("세션 초기화됨");
      render();
    });

    init();
  </script>
</body>
</html>
